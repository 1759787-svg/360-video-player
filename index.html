<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360度動画プレイヤー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }
        #player-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #video-canvas {
            display: block;
            width: 100%;
            flex-grow: 1; /* Take remaining space */
        }
        #controls {
            padding: 1rem;
            background-color: rgba(26, 32, 44, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom modal for alerts */
        #custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 100;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #custom-alert-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="player-container">
        <div id="controls" class="w-full">
            <div class="max-w-4xl mx-auto">
                <label for="videoUrl" class="block text-sm font-medium text-gray-400 mb-2">360度動画のURL</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="videoUrl" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="https://example.com/video.mp4" value="https://bitmovin-a.akamaihd.net/content/playhouse-vr/mp4s/102321_24125_120335_2000_0.mp4">
                    <button id="playButton" class="w-full sm:w-auto text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">再生</button>
                </div>
                 <p class="text-xs text-gray-500 mt-2">注: ブラウザの制限により、動画は音声なしで再生されます。</p>
            </div>
        </div>
        <canvas id="video-canvas"></canvas>
    </div>

    <!-- Video element is hidden, used as a texture source -->
    <video id="video" style="display:none" crossorigin="anonymous" playsinline webkit-playsinline loop></video>

    <!-- Modal for custom alerts -->
    <div id="custom-alert-container" class="hidden">
        <div id="custom-alert-backdrop"></div>
        <div id="custom-alert">
            <p id="custom-alert-message" class="mb-4"></p>
            <button id="custom-alert-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">OK</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const canvas = document.getElementById('video-canvas');
        const video = document.getElementById('video');
        const videoUrlInput = document.getElementById('videoUrl');
        const playButton = document.getElementById('playButton');
        const alertContainer = document.getElementById('custom-alert-container');
        const alertMessage = document.getElementById('custom-alert-message');
        const alertOkButton = document.getElementById('custom-alert-ok');

        let scene, camera, renderer, sphere;
        let isMouseDown = false;
        let onMouseDownPosition = new THREE.Vector2();
        let onMouseDownLat = 0, onMouseDownLon = 0;
        let lat = 0, lon = 0;
        let phi = 0, theta = 0;

        // Custom Alert Function
        function showAlert(message) {
            alertMessage.textContent = message;
            alertContainer.classList.remove('hidden');
        }

        alertOkButton.addEventListener('click', () => {
            alertContainer.classList.add('hidden');
        });

        function init() {
            // Scene
            scene = new THREE.Scene();

            // Camera
            camera = new THREE.PerspectiveCamera(75, canvas.offsetWidth / canvas.offsetHeight, 1, 1100);
            camera.target = new THREE.Vector3(0, 0, 0);

            // Sphere Geometry
            const geometry = new THREE.SphereGeometry(500, 60, 40);
            geometry.scale(-1, 1, 1);

            const texture = new THREE.VideoTexture(video);
            const material = new THREE.MeshBasicMaterial({ map: texture });

            sphere = new THREE.Mesh(geometry, material);
            scene.add(sphere);

            renderer = new THREE.WebGLRenderer({ canvas });
            renderer.setPixelRatio(window.devicePixelRatio);
            resizeCanvas();

            playButton.addEventListener('click', playVideo);
            video.addEventListener('error', (e) => {
                 showAlert('動画の読み込みに失敗しました。URLが正しいか、サーバーのCORS設定が許可されているか確認してください。');
                 console.error('Video Error:', e);
            });

            canvas.addEventListener('mousedown', onPointerStart);
            canvas.addEventListener('mousemove', onPointerMove);
            canvas.addEventListener('mouseup', onPointerEnd);
            canvas.addEventListener('wheel', onDocumentMouseWheel);
            
            canvas.addEventListener('touchstart', onPointerStart, { passive: false });
            canvas.addEventListener('touchmove', onPointerMove, { passive: false });
            canvas.addEventListener('touchend', onPointerEnd);

            window.addEventListener('resize', resizeCanvas);

            animate();
        }

        function playVideo() {
            const videoUrl = videoUrlInput.value;
            if (!videoUrl) {
                showAlert('動画のURLを入力してください。');
                return;
            }
            
            // Mute video to comply with browser autoplay policies
            video.muted = true;
            video.src = videoUrl;
            video.load(); // Explicitly load the new source

            const playPromise = video.play();

            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("動画の再生に失敗しました:", error);
                    showAlert('ブラウザのセキュリティ設定により、動画の再生を開始できませんでした。ページを再読み込みして、もう一度再生ボタンを押してください。');
                });
            }
        }
        
        function onPointerStart(event) {
            isMouseDown = true;
            const clientX = event.clientX || event.touches[0].clientX;
            const clientY = event.clientY || event.touches[0].clientY;
            onMouseDownPosition.set(clientX, clientY);
            onMouseDownLon = lon;
            onMouseDownLat = lat;
        }

        function onPointerMove(event) {
            if (isMouseDown) {
                const clientX = event.clientX || event.touches[0].clientX;
                const clientY = event.clientY || event.touches[0].clientY;
                lon = (onMouseDownPosition.x - clientX) * 0.2 + onMouseDownLon;
                lat = (clientY - onMouseDownPosition.y) * 0.2 + onMouseDownLat;
                lat = Math.max(-85, Math.min(85, lat));
            }
        }

        function onPointerEnd() {
            isMouseDown = false;
        }

        function onDocumentMouseWheel(event) {
            const fov = camera.fov + event.deltaY * 0.05;
            camera.fov = THREE.MathUtils.clamp(fov, 30, 100);
            camera.updateProjectionMatrix();
        }

        function resizeCanvas() {
            const container = document.getElementById('player-container');
            const controls = document.getElementById('controls');
            const newWidth = container.clientWidth;
            const newHeight = container.clientHeight - controls.offsetHeight;

            camera.aspect = newWidth / newHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, newHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            render();
        }

        function render() {
            phi = THREE.MathUtils.degToRad(90 - lat);
            theta = THREE.MathUtils.degToRad(lon);

            camera.target.x = 500 * Math.sin(phi) * Math.cos(theta);
            camera.target.y = 500 * Math.cos(phi);
            camera.target.z = 500 * Math.sin(phi) * Math.sin(theta);

            camera.lookAt(camera.target);
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>

